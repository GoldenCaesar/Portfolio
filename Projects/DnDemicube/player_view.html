<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player View - DnDemicube</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Plus+Jakarta+Sans:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style type="text/tailwindcss">
        :root {
            --primary-color: #141414;
            --secondary-text-color: #a9a9a9;
            --primary-gold: #f4c725;
            --rune-gold: #FFD700;
            --dark-bg: #12100E;
            --paper-bg: #1E1A17;
            --text-light: #EAE3D3;
            --text-muted: #A39B8B;
            --border-color: #3A3529;
        }
        body {
            background-color: var(--dark-bg);
            font-family: 'Noto Serif', serif;
        }
        .fantasy-title {
            font-family: 'Uncial Antiqua', cursive;
        }
        #player-map-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; position: relative; }
        #player-map-container > canvas {
            position: absolute;
            max-width: 100%;
            max-height: 100%;
            border: 1px solid #3f4c5a;
        }
        #player-canvas {
            background-color: #2a3138; /* Keep background on base canvas only */
        }
        .note-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }
        .note-preview-content {
            background-color: #2a3138;
            padding: 20px;
            border-radius: 5px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            color: #e0e0e0;
        }
        #character-preview-body img {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 5px;
            float: left;
            margin-right: 15px;
            margin-bottom: 10px;
        }
        .quote-font {
            font-family: 'Playfair Display', serif;
        }

        @keyframes slide-up-in {
            from {
            transform: translateY(100%);
            opacity: 0;
            }
            to {
            transform: translateY(0);
            opacity: 1;
            }
        }

        @keyframes slide-up-out {
            from {
            transform: translateY(0);
            opacity: 1;
            }
            to {
            transform: translateY(-100%);
            opacity: 0;
            }
        }

        .animate-in {
            animation: slide-up-in 1s ease-out forwards;
        }

        .animate-out {
            animation: slide-up-out 1s ease-in forwards;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        .overlay-content {
            background-color: rgba(42, 49, 56, 0.85);
            padding: 20px;
            border: 1px solid #3f4c5a;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
            position: relative;
            color: #e0e0e0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
        }
        #initiative-tracker-overlay .overlay-content {
            width: 800px;
            max-width: 90vw;
            height: 600px;
            max-height: 80vh;
        }
        #initiative-tracker-content { min-height: 0; }
        .list-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #15191e;
            border: 1px solid #3f4c5a;
            padding: 10px;
            min-height: 300px;
        }
        .initiative-character-card {
            display: flex;
            align-items: center;
            background-color: #2a3138;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 5px;
            border-left: 3px solid #4a5f7a;
        }
        .initiative-character-card.active-turn {
            border-left-color: #b6cae1;
            box-shadow: 0 0 8px #b6cae1;
        }
        .initiative-character-card img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        .initiative-character-info { flex-grow: 1; }
        .initiative-character-info h4 { margin: 0 0 2px 0; color: #e0e0e0; font-size: 0.9em; }
        .initiative-character-info p { margin: 0; font-size: 0.8em; color: #a0b4c9; }
        .initiative-character-initials {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #4a5f7a;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #e0e0e0;
            flex-shrink: 0;
            margin-right: 15px;
            font-size: 1.2em;
        }
        .initiative-value { font-size: 1.2em; font-weight: bold; margin-left: 10px; min-width: 30px; text-align: center; }
        .initiative-character-hp { margin-left: 10px; font-size: 0.9em; }
        .initiative-character-hp input { background-color: #15191e; color: #e0e0e0; border: 1px solid #3f4c5a; border-radius: 3px; text-align: center; width: 50px; }
        #initiative-timers { font-family: 'Courier New', Courier, monospace; font-size: 1.1em; color: #b6cae1; }

        .dice-icon-menu { position: absolute; bottom: 60px; right: 5px; background-color: #2a3138; border: 1px solid #3f4c5a; border-radius: 5px; z-index: 1001; width: 200px; }
        .dice-menu-item { padding: 10px 15px; cursor: pointer; color: #e0e0e0; }
        .dice-menu-item:hover { background-color: #3f4c5a; color: #b6cae1; }

        .dice-dialogue { position: absolute; bottom: 60px; right: 5px; width: 300px; max-height: 200px; background-color: rgba(40,50,60,0.9); border-radius: 10px; padding: 10px; display: none; flex-direction: column-reverse; overflow: hidden; border: 1px solid #4a5f7a; z-index: 1010; }
        .dice-dialogue.persistent-log { position: fixed; right: 20px; bottom: 20px; height: 400px; max-height: 80vh; flex-direction: column; overflow-y: auto; }
        .dice-dialogue-message { background-color: rgba(21,25,30,0.8); color: #e0e0e0; padding: 0; margin-bottom: 5px; border-radius: 5px; font-size: 0.9em; border-left: 3px solid #76a9d7; }
        .dice-roll-card-content { display: flex; gap: 12px; padding: 16px; }
        .dice-roll-profile-pic { width: 40px; height: 40px; border-radius: 50%; background-color: #4a5f7a; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #e0e0e0; flex-shrink: 0; }
        .dice-roll-text-container { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .dice-roll-name { font-size: 16px; line-height: 1.25; margin: 0; }
        .dice-roll-name strong { font-weight: bold; }
        .dice-roll-details { font-size: 16px; line-height: 1.5; margin: 0; color: #a0b4c9; }
        .dice-roll-sum-text { font-size: 1.2em; font-weight: bold; color: #e0e0e0; }
        #action-log-minimize-button { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #e0e0e0; font-size: 20px; cursor: pointer; padding: 0 5px; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1050; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: none; }
        .toast-message { pointer-events: auto; width: 350px; animation: toast-fade-in 0.5s ease-out; }
        @keyframes toast-fade-in { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toast-fade-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

        .token-stat-block { background-color: #2a3138; border: 1px solid #3f4c5a; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 1002; color: #e0e0e0; padding: 10px; width: 250px; max-height: 400px; overflow-y: auto; }
        .token-stat-block-content h4, .token-stat-block-content p { margin: 0 0 5px 0; text-align: center; }
        .token-stat-block-content .stat-block-health { display: flex; align-items: center; margin-bottom: 10px; }
        .token-stat-block-content .token-stat-block-hp-input { width: 50px; margin: 0 5px; background-color: #15191e; color: #e0e0e0; border: 1px solid #3f4c5a; }
    </style>
</head>
<body>
    <div id="slideshow-container" class="relative w-full h-screen flex items-center justify-center overflow-hidden bg-black" style="display: none;">
    <div id="content-container" class="text-center text-white p-8">
    <div class="mx-auto mb-4 w-48 h-48 rounded-full border-4 border-gray-700 relative">
        <img id="portrait-img" src="" alt="Character Portrait" class="w-full h-full rounded-full object-cover">
        <div id="portrait-initials" class="w-full h-full rounded-full bg-gray-600 flex items-center justify-center text-5xl font-bold text-white absolute top-0 left-0" style="display: none;"></div>
    </div>
        <p id="quote-text" class="text-3xl italic quote-font mb-4">"</p>
        <p id="author-text" class="text-xl font-bold"></p>
    </div>
    </div>
    <div id="player-map-container" class="w-full h-screen">
        <canvas id="player-canvas"></canvas>
        <canvas id="player-shadow-canvas" style="pointer-events: none;"></canvas>
        <canvas id="fog-canvas" style="pointer-events: none;"></canvas>
        <div id="dice-roller-icon" class="absolute bottom-5 right-5 w-12 h-12 cursor-pointer z-10">
            <img src="assets/d20icon.png" alt="d20 icon" class="w-full h-full">
        </div>
        <div id="dice-icon-menu" class="dice-icon-menu" style="display: none;">
            <!-- Player view menu is controlled by DM, so it's empty initially -->
        </div>
        <div id="dice-dialogue-record" class="dice-dialogue"></div>
        <div id="toast-container"></div>
        <div id="token-stat-block" class="token-stat-block" style="display: none; position: absolute; z-index: 1003;">
            <div class="token-stat-block-content">
                <h4 id="token-stat-block-char-name"></h4>
                <p id="token-stat-block-player-name"></p>
                <div class="stat-block-health">
                    <label>HP:</label>
                    <span id="token-stat-block-hp"></span>
                    <span id="token-stat-block-max-hp"></span>
                </div>
                <div class="stat-block-rolls" style="display:none;">
                    <h5>Rolls</h5>
                    <ul id="token-stat-block-rolls-list"></ul>
                </div>
            </div>
        </div>
        <div id="initiative-tracker-overlay" class="overlay" style="display: none;">
            <div class="overlay-content" style="max-width: 1000px; width: 95%;">
                <h2 id="initiative-tracker-title">Initiative</h2>
                <div id="initiative-tracker-content" style="display: flex; flex-grow: 1; gap: 20px; margin-top: 15px;">
                    <div id="initiative-active-list-container" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="list-container" style="flex-grow: 1;">
                            <ul id="initiative-active-list" style="list-style: none; padding: 0; margin: 0;">
                                <!-- Active initiative participants will be populated by JS -->
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="initiative-controls" style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 15px;">
                    <div id="initiative-timers" style="display: none; position: absolute; left: 20px; gap: 20px; background-color: #15191e; padding: 5px 10px; border-radius: 5px;">
                        <span>Real Time: <span id="real-time-timer">00:00:00</span></span>
                        <span>Game Time: <span id="game-time-timer">0s</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="quest-log-overlay" style="display: none;" class="absolute inset-0 bg-black/60 backdrop-blur-sm z-20">
        <div class="relative z-10 flex flex-col h-full max-w-2xl mx-auto bg-paper-bg/80 border-x-2 border-border-color/80 shadow-2xl shadow-black">
            <header class="flex items-center p-4 border-b border-border-color/50">
                <h1 class="fantasy-title text-2xl text-center flex-1 text-primary-gold">Quest Log</h1>
            </header>
            <main class="flex-grow p-6 overflow-y-auto">
                <h2 id="quest-log-title" class="fantasy-title text-3xl text-primary-gold mb-6 text-center"></h2>
                <div id="quest-log-steps-container" class="space-y-4">
                    <!-- Completed steps will be injected here by JS -->
                    <!-- Divider will be injected here by JS -->
                    <!-- Next step will be injected here by JS -->
                </div>
            </main>
        </div>
    </div>

    <div id="note-preview-overlay" class="note-preview-overlay" style="display: none;">
        <div class="note-preview-content">
            <div id="note-preview-body"></div>
        </div>
    </div>

    <div id="character-preview-overlay" class="note-preview-overlay" style="display: none;">
        <div class="note-preview-content">
            <button id="character-preview-close" class="note-preview-close">&times;</button>
            <div id="character-preview-body"></div>
        </div>
    </div>
    <script src="player_view.js"></script>
    <div id="dice-roller-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-20" style="display: none;">
        <!-- ... dice roller content ... -->
    </div>
</body>
</html>
