<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player View - DnDemicube</title>
    <style>
        body { margin: 0; background-color: #15191e; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #player-map-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #player-canvas { max-width: 100%; max-height: 100%; border: 1px solid #3f4c5a; background-color: #2a3138;}
    </style>
</head>
<body>
    <div id="player-map-container">
        <canvas id="player-canvas"></canvas>
    </div>

    <script>
        const playerCanvas = document.getElementById('player-canvas');
        const pCtx = playerCanvas.getContext('2d');
        let currentMapImage = null;

        function drawPlayerMap(image) {
            if (!image) return;

            // Adjust canvas size to image aspect ratio, fitting within player-map-container
            const mapContainer = document.getElementById('player-map-container');
            const containerWidth = mapContainer.clientWidth;
            const containerHeight = mapContainer.clientHeight;

            let canvasWidth = image.width;
            let canvasHeight = image.height;

            if (canvasWidth > containerWidth) {
                const ratio = containerWidth / canvasWidth;
                canvasWidth = containerWidth;
                canvasHeight *= ratio;
            }
            if (canvasHeight > containerHeight) {
                const ratio = containerHeight / canvasHeight;
                canvasHeight = containerHeight;
                canvasWidth *= ratio;
            }

            playerCanvas.width = canvasWidth;
            playerCanvas.height = canvasHeight;
            pCtx.drawImage(image, 0, 0, playerCanvas.width, playerCanvas.height);
            currentMapImage = image;
        }

        window.addEventListener('message', (event) => {
            // For security, you might want to check event.origin in a real application
            // if (event.origin !== 'expected_dm_origin') return;

            if (event.data && event.data.mapDataUrl) {
                const mapDataUrl = event.data.mapDataUrl;
                let messageType = event.data.type;

                if (messageType === 'loadMap' || messageType === 'showSubMap' || messageType === 'showMainMap') {
                    console.log(`Player view received ${messageType}: ${mapDataUrl.substring(0,30)}...`);
                    const img = new Image();
                    img.onload = () => {
                        drawPlayerMap(img); // This function already updates currentMapImage
                    };
                    img.onerror = () => {
                        console.error(`Error loading image for player view (${messageType}).`);
                        pCtx.clearRect(0, 0, playerCanvas.width, playerCanvas.height);
                        pCtx.fillStyle = 'red';
                        pCtx.font = '16px sans-serif';
                        pCtx.textAlign = 'center';
                        pCtx.fillText(`Error loading ${messageType === 'showSubMap' ? 'sub-map' : 'map'}.`, playerCanvas.width / 2, playerCanvas.height / 2);
                    };
                    img.src = mapDataUrl;
                } else {
                    console.log("Player view received unhandled message type:", event.data.type);
                }
            } else {
                console.log("Player view received message with no mapDataUrl or type:", event.data);
            }
        });

        // Optional: Resize canvas if window size changes
        window.addEventListener('resize', () => {
            if(currentMapImage) {
                // A brief timeout can help ensure layout changes have settled
                setTimeout(() => drawPlayerMap(currentMapImage), 50);
            }
        });

        // Initial placeholder for player canvas
        function drawPlaceholder() {
            playerCanvas.width = playerCanvas.parentElement.clientWidth * 0.95; // A bit more fill
            playerCanvas.height = playerCanvas.parentElement.clientHeight * 0.95;
            pCtx.fillStyle = '#2a3138';
            pCtx.fillRect(0, 0, playerCanvas.width, playerCanvas.height);
            pCtx.fillStyle = '#555';
            pCtx.font = '20px sans-serif';
            pCtx.textAlign = 'center';
            pCtx.fillText('Waiting for DM to share map...', playerCanvas.width / 2, playerCanvas.height / 2);
        }
        drawPlaceholder();

    </script>
</body>
</html>
