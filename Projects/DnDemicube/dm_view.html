<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DM View - DnDemicube</title>
    <style>
        body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; background-color: #15191e; color: #e0e0e0; }
        #sidebar { width: 250px; background-color: #20262d; padding: 15px; border-right: 1px solid #3f4c5a; display: flex; flex-direction: column; gap: 10px; }
        .sidebar-section { margin-bottom: 20px; border-top: 1px solid #3f4c5a; padding-top: 10px; }
        .sidebar-section h3, .sidebar-section h4 { margin-top: 0; border-bottom: 1px solid #3f4c5a; padding-bottom: 5px;}
        .tabs { display: flex; border-bottom: 1px solid #3f4c5a; margin-bottom: 10px;}
        .tab-button { background: none; border: none; padding: 10px 15px; cursor: pointer; color: #e0e0e0; font-size: 14px; border-bottom: 2px solid transparent; }
        .tab-button.active { border-bottom-color: #b6cae1; color: #b6cae1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #map-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; padding: 10px; }
        #dm-canvas { max-width: 100%; max-height: 100%; border: 1px solid #3f4c5a; background-color: #2a3138; }
        button, input[type="file"] {
            padding: 8px 12px;
            background-color: #b6cae1;
            max-width: 100%;
            box-sizing: border-box;
            color: #15191e;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover, input[type="file"]:hover {
            background-color: #a0b4c9;
        }
        label { display: block; margin-bottom: 5px; }
        h3 { margin-top: 0; border-bottom: 1px solid #3f4c5a; padding-bottom: 5px;}
        .button-like-label {
            padding: 8px 12px;
            background-color: #b6cae1;
            color: #15191e;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-block; /* To behave like a button */
        }
        .button-like-label:hover {
            background-color: #a0b4c9;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="tabs">
            <button class="tab-button active" data-tab="tab-dm-controls">DM Controls</button>
            <button class="tab-button" data-tab="tab-notes">Notes</button>
            <button class="tab-button" data-tab="tab-characters">Characters</button>
        </div>

        <div id="tab-dm-controls" class="tab-content active">
            <div class="sidebar-section">
                <h3>Map Management</h3>
                <div>
                    <label for="upload-map-button">Upload Main Map:</label>
                    <input type="file" id="upload-map-button" accept="image/*">
                </div>
                <div id="edit-map-controls" style="margin-top: 10px;">
                    <h4>Edit Map</h4>
                    <button id="new-submap-button">New Sub Map</button>
                    <div style="margin-top: 10px;">
                        <label for="upload-submap-button" id="upload-submap-label" style="display:none;">Upload Sub-Map Image:</label>
                        <input type="file" id="upload-submap-button" accept="image/*" style="display:none;">
                    </div>
                </div>
            </div>

            <div class="sidebar-section" id="active-maps-section">
                <h3>Active</h3>
                <ul id="active-maps-list">
                    <!-- Active maps will be listed here -->
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Campaign</h3>
                 <div id="campaign-io-controls">
                    <button id="save-campaign-button">Save Campaign</button>
                    <div style="margin-top: 10px;">
                        <label for="load-campaign-input" class="button-like-label">Load Campaign</label>
                        <input type="file" id="load-campaign-input" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
             <div class="sidebar-section">
                <h3>Player View</h3>
                <button id="open-player-view-button">Open Player View</button>
            </div>
        </div>

        <div id="tab-notes" class="tab-content">
            <h3>Notes</h3>
            <textarea placeholder="Campaign notes..." style="width: 100%; height: 200px;"></textarea>
        </div>

        <div id="tab-characters" class="tab-content">
            <h3>Characters</h3>
            <p>Character management will go here.</p>
        </div>
    </div>
    <div id="map-container">
        <canvas id="dm-canvas"></canvas>
    </div>

    <script>
        // Tab switching logic
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });
        const openPlayerViewButton = document.getElementById('open-player-view-button');
        const uploadMapButton = document.getElementById('upload-map-button');
        const dmCanvas = document.getElementById('dm-canvas');
        const ctx = dmCanvas.getContext('2d');
        const newSubmapButton = document.getElementById('new-submap-button');
        const uploadSubmapButton = document.getElementById('upload-submap-button');
        const uploadSubmapLabel = document.getElementById('upload-submap-label');
        const activeMapsList = document.getElementById('active-maps-list');

        let playerWindow = null;
        let currentMapImage = null;
        let dmDisplayingSubMapUrl = null; // Added to track if DM is viewing a submap
        let dmDisplayingSubMapImage = null; // Added to hold the Image object for the submap
        let campaignData = {
            mainMapName: "Main Map", // Default name
            mainMapUrl: null,
            subMaps: [] // { area: {x, y, w, h, originalImgW, originalImgH}, mapUrl: dataUrl, name: "Sub Map X" }
        };

        let isSelectingArea = false;
        let selectionStart = null;
        let currentSelectionRect = null; // For storing the current selection before assigning a submap

        // --- Main Map Drawing and Handling ---
        function drawDmMap() {
            const mapContainer = document.getElementById('map-container');
            const containerWidth = mapContainer.clientWidth - 20; // Account for padding
            const containerHeight = mapContainer.clientHeight - 20; // Account for padding

            let imageToDraw = null;
            let originalWidth = 0;
            let originalHeight = 0;

            if (dmDisplayingSubMapUrl && dmDisplayingSubMapImage && dmDisplayingSubMapImage.complete) {
                console.log("[DM View] drawDmMap() called for SubMap. Image:", dmDisplayingSubMapImage ? `Image(${dmDisplayingSubMapImage.width}x${dmDisplayingSubMapImage.height})` : 'null');
                imageToDraw = dmDisplayingSubMapImage;
                originalWidth = dmDisplayingSubMapImage.naturalWidth;
                originalHeight = dmDisplayingSubMapImage.naturalHeight;
            } else if (currentMapImage && currentMapImage.complete) {
                console.log("[DM View] drawDmMap() called for MainMap. Image:", currentMapImage ? `Image(${currentMapImage.width}x${currentMapImage.height})` : 'null');
                imageToDraw = currentMapImage;
                originalWidth = currentMapImage.naturalWidth;
                originalHeight = currentMapImage.naturalHeight;
            } else {
                console.log("[DM View] drawDmMap: No image available (neither main nor submap), calling drawPlaceholder().");
                drawPlaceholder();
                return;
            }
            
            if (originalWidth === 0 || originalHeight === 0) { // Image might not be fully loaded yet or is invalid
                 console.log("[DM View] drawDmMap: Original image dimensions are zero. Calling drawPlaceholder().");
                drawPlaceholder(); // Or some other fallback
                return;
            }

            console.log("[DM View] drawDmMap: imageToDraw properties:", originalWidth, originalHeight);
            console.log("[DM View] drawDmMap: mapContainer dimensions (clientWidth-20, clientHeight-20):", containerWidth, containerHeight);

            let canvasWidth = originalWidth;
            let canvasHeight = originalHeight;
            const aspectRatio = originalWidth / originalHeight;

            if (canvasWidth > containerWidth && containerWidth > 0) {
                canvasWidth = containerWidth;
                canvasHeight = canvasWidth / aspectRatio;
            }
            if (canvasHeight > containerHeight && containerHeight > 0) {
                canvasHeight = containerHeight;
                canvasWidth = canvasHeight * aspectRatio;
            }

            console.log("[DM View] drawDmMap: Calculated canvas dimensions (width, height):", canvasWidth, canvasHeight);
            dmCanvas.width = canvasWidth;
            dmCanvas.height = canvasHeight;

            ctx.clearRect(0, 0, dmCanvas.width, dmCanvas.height);
            console.log("[DM View] drawDmMap: Canvas cleared.");
            ctx.drawImage(imageToDraw, 0, 0, dmCanvas.width, dmCanvas.height);
            console.log("[DM View] drawDmMap: Image drawn on canvas.");

            // If drawing the main map, also draw sub-map areas and selection rectangle
            if (!dmDisplayingSubMapUrl && currentMapImage) {
                campaignData.subMaps.forEach(subMap => {
                    // Ensure the area's original dimensions match the current main map's original dimensions
                    // This check is important if a campaign is loaded with a main map that might have
                    // different natural dimensions than the one active when submap areas were defined.
                    // For simplicity, we'll assume they are consistent for now or that submap areas
                    // are always defined relative to currentMapImage.naturalWidth/Height.
                    if (subMap.area.originalImgW === currentMapImage.naturalWidth && subMap.area.originalImgH === currentMapImage.naturalHeight) {
                        drawSubMapArea(subMap.area, currentMapImage.naturalWidth, currentMapImage.naturalHeight);
                    } else {
                        // This case might require re-scaling or warning the user.
                        // For now, we'll attempt to draw it using the stored original dimensions,
                        // but it might be misaligned if the main map image changed fundamentally.
                        console.warn("SubMap area was defined for a main map of different dimensions. Display might be inaccurate.");
                        drawSubMapArea(subMap.area, subMap.area.originalImgW, subMap.area.originalImgH);
                    }
                });

                if (isSelectingArea && selectionStart && currentSelectionRect) {
                    // currentSelectionRect during selection is in canvas coordinates, so direct drawing is fine.
                    ctx.strokeStyle = 'rgba(255, 0, 0, 0.7)';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(currentSelectionRect.x, currentSelectionRect.y, currentSelectionRect.w, currentSelectionRect.h);
                }
            }
        }

        // --- Sub Map Area Drawing ---
        // Modified to accept original image dimensions for scaling
        function drawSubMapArea(area, baseImageNaturalWidth, baseImageNaturalHeight) {
            if (!dmCanvas.width || !dmCanvas.height) return; // Canvas not ready

            // Scale factor based on current display size vs original image size when area was defined
            // The area's originalImgW/H should correspond to baseImageNaturalWidth/Height
            const scaleX = dmCanvas.width / baseImageNaturalWidth;
            const scaleY = dmCanvas.height / baseImageNaturalHeight;

            ctx.strokeStyle = 'rgba(0, 255, 0, 0.7)'; // Green for existing submap areas
            ctx.lineWidth = 3; // Make it a bit thicker
            ctx.strokeRect(area.x * scaleX, area.y * scaleY, area.w * scaleX, area.h * scaleY);
        }


        openPlayerViewButton.addEventListener('click', () => {
            if (playerWindow && !playerWindow.closed) {
                playerWindow.focus();
            } else {
                // Opens in a new tab or window, standard behavior. '_blank' is key.
                playerWindow = window.open('player_view.html', '_blank');
                // If a main map is already loaded in campaignData, send it
                if (campaignData.mainMapUrl) {
                    // Ensure playerWindow is fully opened and ready
                    const checkPlayerWindowReady = setInterval(() => {
                        if (playerWindow && playerWindow.closed === false && playerWindow.postMessage) {
                            clearInterval(checkPlayerWindowReady);
                            playerWindow.postMessage({ type: 'loadMap', mapDataUrl: campaignData.mainMapUrl }, '*');
                        } else if (!playerWindow || playerWindow.closed) {
                            // Window was closed before it could be messaged
                            clearInterval(checkPlayerWindowReady);
                        }
                    }, 200); // Check every 200ms
                    // Timeout to prevent indefinite interval if window fails to open or is blocked
                    setTimeout(() => clearInterval(checkPlayerWindowReady), 5000);
                }
            }
        });

        uploadMapButton.addEventListener('change', (event) => {
            console.log("[DM View] uploadMapButton 'change' event fired.");
            const file = event.target.files[0];
            if (file) {
                console.log("[DM View] File selected:", file.name, file.type);
                const reader = new FileReader();
                reader.onload = (e) => {
                    console.log("[DM View] FileReader 'onload' event fired.");
                    const img = new Image();
                    img.onload = () => {
                        console.log("[DM View] Image 'onload' event fired. Image properties:", img.width, img.height, "src length:", e.target.result.length);
                        currentMapImage = img; // Set the global currentMapImage
                        console.log("[DM View] currentMapImage set:", currentMapImage ? currentMapImage.width : 'null');
                        campaignData.mainMapUrl = e.target.result; // Store data URL
                        campaignData.mainMapName = file.name.split('.')[0] || "Main Map"; // Use filename as name
                        campaignData.subMaps = []; // Clear previous sub-maps
                        console.log("[DM View] Calling drawDmMap() from uploadMapButton.");
                        drawDmMap(); // Redraws the map and any existing (now cleared) submap areas
                        updateActiveMapsList(); // Update the list
                        if (playerWindow && !playerWindow.closed) {
                            playerWindow.postMessage({ type: 'loadMap', mapDataUrl: campaignData.mainMapUrl }, '*');
                        }
                    };
                    img.onerror = () => {
                        console.error("Error loading image for DM view.");
                        alert("Error loading image.");
                    };
                    img.src = e.target.result;
                };
                reader.onerror = () => {
                    console.error("Error reading file.");
                    alert("Error reading file.");
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Area Selection Logic ---
        newSubmapButton.addEventListener('click', () => {
            if (!currentMapImage) {
                alert("Please upload a main map first.");
                return;
            }
            isSelectingArea = !isSelectingArea;
            if (isSelectingArea) {
                newSubmapButton.textContent = "Cancel Selection";
                dmCanvas.style.cursor = 'crosshair';
                uploadSubmapButton.style.display = 'none';
                uploadSubmapLabel.style.display = 'none';
                currentSelectionRect = null; // Clear any pending selection rectangle for submap assignment
            } else {
                newSubmapButton.textContent = "New Sub Map";
                dmCanvas.style.cursor = 'default';
                selectionStart = null; // Clear selection start point
                // currentSelectionRect is already handled or null
                drawDmMap(); // Redraw to remove temporary selection rectangle if mouse wasn't released on canvas
            }
        });

        dmCanvas.addEventListener('mousedown', (e) => {
            if (!isSelectingArea || !currentMapImage) return;
            const rect = dmCanvas.getBoundingClientRect();
            // selectionStart is relative to the canvas, not the image
            selectionStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            // Initialize currentSelectionRect for drawing the feedback rectangle
            currentSelectionRect = { x: selectionStart.x, y: selectionStart.y, w: 0, h: 0 };
        });

        dmCanvas.addEventListener('mousemove', (e) => {
            if (!isSelectingArea || !selectionStart || !currentMapImage) return;
            const rect = dmCanvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            currentSelectionRect.w = currentX - selectionStart.x;
            currentSelectionRect.h = currentY - selectionStart.y;
            drawDmMap(); // Redraw to show live selection rectangle (drawDmMap handles this)
        });

        dmCanvas.addEventListener('mouseup', (e) => {
            if (!isSelectingArea || !selectionStart || !currentMapImage) return;

            const rect = dmCanvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;

            // Finalize selection rectangle, ensuring w and h are positive
            // These are still in canvas coordinates
            let canvasSelection = {
                x: Math.min(selectionStart.x, endX),
                y: Math.min(selectionStart.y, endY),
                w: Math.abs(endX - selectionStart.x),
                h: Math.abs(endY - selectionStart.y)
            };

            if (canvasSelection.w < 5 || canvasSelection.h < 5) { // Ignore tiny selections
                selectionStart = null;
                currentSelectionRect = null; // Clear the drawing rectangle
                isSelectingArea = false;
                newSubmapButton.textContent = "New Sub Map";
                dmCanvas.style.cursor = 'default';
                drawDmMap(); // Redraw to clear any visual artifacts
                return;
            }

            // Convert canvas coordinates to image-relative coordinates for consistent storage
            const scaleX = currentMapImage.naturalWidth / dmCanvas.width;
            const scaleY = currentMapImage.naturalHeight / dmCanvas.height;

            // This is the rectangle that will be stored and used for submap association
            const imageRelativeRect = {
                x: canvasSelection.x * scaleX,
                y: canvasSelection.y * scaleY,
                w: canvasSelection.w * scaleX,
                h: canvasSelection.h * scaleY,
                originalImgW: currentMapImage.naturalWidth,
                originalImgH: currentMapImage.naturalHeight
            };

            // currentSelectionRect is now the one to be associated with an uploaded submap
            // but it should be the imageRelativeRect
            currentSelectionRect = imageRelativeRect;

            isSelectingArea = false;
            newSubmapButton.textContent = "New Sub Map";
            dmCanvas.style.cursor = 'default';
            selectionStart = null; // Reset for next selection

            uploadSubmapLabel.style.display = 'block';
            uploadSubmapButton.style.display = 'block';
            uploadSubmapButton.value = null;
            uploadSubmapButton.focus();

            // Redraw to clear the temporary red selection rectangle.
            // Then draw a temporary "pending" blue rectangle for the confirmed area.
            drawDmMap();
            ctx.strokeStyle = 'rgba(100, 100, 255, 0.8)'; // A distinct color for pending link
            ctx.lineWidth = 2;
            ctx.strokeRect(canvasSelection.x, canvasSelection.y, canvasSelection.w, canvasSelection.h);
        });

        uploadSubmapButton.addEventListener('change', (event) => {
            if (!currentSelectionRect) { // This should be the imageRelativeRect stored from mouseup
                alert("An area selection was not properly finalized. Please select an area again.");
                uploadSubmapButton.style.display = 'none';
                uploadSubmapLabel.style.display = 'none';
                return;
            }
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const subMapName = file.name.split('.')[0] || `Sub-Map ${campaignData.subMaps.length + 1}`;
                    campaignData.subMaps.push({
                        area: currentSelectionRect, // Store the image-relative rectangle
                        mapUrl: e.target.result,
                        name: subMapName
                    });
                    currentSelectionRect = null; // Clear the pending selection
                    uploadSubmapButton.style.display = 'none';
                    uploadSubmapLabel.style.display = 'none';
                    drawDmMap(); // Redraw to show the new submap area permanently (green)
                    updateActiveMapsList(); // Update the list
                };
                reader.onerror = () => { console.error("Error reading submap file."); alert("Error reading submap file."); };
                reader.readAsDataURL(file);
            }
        });

// --- Canvas Click Logic for Player View Control ---
dmCanvas.addEventListener('click', (e) => {
    if (!currentMapImage || isSelectingArea) { // Don't trigger navigation during area selection
        return;
    }

    const rect = dmCanvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;

    // Convert click coordinates to be relative to the original image dimensions for comparison
    const scaleX = currentMapImage.naturalWidth / dmCanvas.width;
    const scaleY = currentMapImage.naturalHeight / dmCanvas.height;
    const imageRelativeClickX = clickX * scaleX;
    const imageRelativeClickY = clickY * scaleY;

    let clickedSubMap = null;
    for (const subMap of campaignData.subMaps) {
        const area = subMap.area;
        // area.x, area.y, area.w, area.h are already relative to original image
        if (imageRelativeClickX >= area.x && imageRelativeClickX <= area.x + area.w &&
            imageRelativeClickY >= area.y && imageRelativeClickY <= area.y + area.h) {
            clickedSubMap = subMap;
            break;
        }
    }

    if (clickedSubMap) {
        console.log("DM clicked on submap area. DM view will show submap. Player view will be sent submap.");
        dmDisplayingSubMapUrl = clickedSubMap.mapUrl;
        dmDisplayingSubMapImage = new Image();
        dmDisplayingSubMapImage.onload = () => {
            drawDmMap(); // Redraw DM map with the submap
        };
        dmDisplayingSubMapImage.onerror = () => {
            console.error("Error loading submap image for DM view.");
            dmDisplayingSubMapUrl = null; // Revert
            dmDisplayingSubMapImage = null;
            drawDmMap(); // Redraw main map
        };
        dmDisplayingSubMapImage.src = dmDisplayingSubMapUrl;

        if (playerWindow && !playerWindow.closed) {
            playerWindow.postMessage({ type: 'showSubMap', mapDataUrl: clickedSubMap.mapUrl }, '*');
        }
    } else {
        // Click was on the main map (or current submap), not activating a different sub-map area
        if (dmDisplayingSubMapUrl) { // If DM was viewing a submap, switch back to main map
            console.log("DM clicked (not on a new submap area) while viewing a submap. Switching DM and Player to main map.");
            dmDisplayingSubMapUrl = null;
            dmDisplayingSubMapImage = null;
            drawDmMap(); // Redraw DM map with the main map
            if (playerWindow && !playerWindow.closed && campaignData.mainMapUrl) {
                playerWindow.postMessage({ type: 'showMainMap', mapDataUrl: campaignData.mainMapUrl }, '*');
            }
        } else { // DM was already viewing the main map, and clicked on it (not a submap area)
            console.log("DM clicked on main map (no change for DM). Ensuring player sees main map.");
             // This case primarily ensures player is synced if they were somehow out of sync,
             // or if it's an initial click after loading.
            if (playerWindow && !playerWindow.closed && campaignData.mainMapUrl) {
                playerWindow.postMessage({ type: 'showMainMap', mapDataUrl: campaignData.mainMapUrl }, '*');
            }
        }
    }
    updateActiveMapsList(); // Update the list after a click
});

        // --- Active Maps List Update ---
        function updateActiveMapsList() {
            activeMapsList.innerHTML = ''; // Clear existing list

            if (campaignData.mainMapUrl) {
                const mainMapItem = document.createElement('li');
                mainMapItem.textContent = campaignData.mainMapName || "Main Map";
                mainMapItem.style.cursor = 'pointer';
                if (!dmDisplayingSubMapUrl) { // Main map is active
                    mainMapItem.style.fontWeight = 'bold';
                }
                mainMapItem.addEventListener('click', () => {
                    if (dmDisplayingSubMapUrl) { // Only switch if not already on main map
                        dmDisplayingSubMapUrl = null;
                        dmDisplayingSubMapImage = null;
                        drawDmMap();
                        if (playerWindow && !playerWindow.closed) {
                            playerWindow.postMessage({ type: 'showMainMap', mapDataUrl: campaignData.mainMapUrl }, '*');
                        }
                        updateActiveMapsList(); // Re-render list to update active state
                    }
                });
                activeMapsList.appendChild(mainMapItem);

                if (campaignData.subMaps.length > 0) {
                    const subMapListElement = document.createElement('ul');
                    campaignData.subMaps.forEach((subMap, index) => {
                        const subMapItem = document.createElement('li');
                        subMapItem.textContent = subMap.name || `Sub-Map ${index + 1}`;
                        subMapItem.style.cursor = 'pointer';
                        subMapItem.style.paddingLeft = '15px';
                        if (dmDisplayingSubMapUrl === subMap.mapUrl) { // This sub-map is active
                            subMapItem.style.fontWeight = 'bold';
                        }
                        subMapItem.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent click from reaching canvas
                            // If this submap is already active and its image is loaded, do nothing
                            if (dmDisplayingSubMapUrl === subMap.mapUrl && dmDisplayingSubMapImage && dmDisplayingSubMapImage.src === subMap.mapUrl && dmDisplayingSubMapImage.complete) {
                                console.log("[Active List] Clicked already active and loaded sub-map:", subMap.name);
                                return;
                            }
                            console.log("[Active List] Clicked sub-map in list:", subMap.name, "Target URL:", subMap.mapUrl);

                            dmDisplayingSubMapUrl = subMap.mapUrl; // Tentatively set, image might fail to load
                            const newSubImage = new Image();
                            newSubImage.onload = () => {
                                dmDisplayingSubMapImage = newSubImage; // Assign once fully loaded
                                console.log("[Active List] Sub-map image loaded, calling drawDmMap for:", subMap.name);
                                drawDmMap(); // Draw the new sub-map

                                if (playerWindow && !playerWindow.closed) {
                                    playerWindow.postMessage({ type: 'showSubMap', mapDataUrl: subMap.mapUrl }, '*');
                                    console.log("[Active List] Sent sub-map to player:", subMap.name);
                                }
                                console.log("[Active List] Updating list after drawing sub-map:", subMap.name);
                                updateActiveMapsList(); // Refresh bolding
                            };
                            newSubImage.onerror = () => {
                                console.error("[Active List] Error loading submap image from active list for:", subMap.name);
                                // If this failed load was for the URL we just tried to set
                                if (dmDisplayingSubMapUrl === subMap.mapUrl) {
                                    dmDisplayingSubMapUrl = null; // Revert to main map display logic
                                    dmDisplayingSubMapImage = null;
                                }
                                drawDmMap(); // Redraw whatever is current (likely main map or placeholder)
                                updateActiveMapsList(); // Still update list to reflect potential reversion
                            };
                            newSubImage.src = subMap.mapUrl;
                            // dmDisplayingSubMapImage is not set to newSubImage here yet, only in onload.
                            // This means if updateActiveMapsList was called synchronously here, it might not see the *new* image yet.
                        });
                        subMapListElement.appendChild(subMapItem);
                    });
                    mainMapItem.appendChild(subMapListElement);
                }
            }
        }


        // Optional: Resize canvas if window size changes
        window.addEventListener('resize', () => {
            setTimeout(() => drawDmMap(), 50); // drawDmMap will use currentMapImage
        });

        // Initial placeholder for DM canvas until map is loaded
        function drawPlaceholder() {
            const placeholderWidth = dmCanvas.parentElement.clientWidth > 100 ? dmCanvas.parentElement.clientWidth * 0.8 : 300;
            const placeholderHeight = dmCanvas.parentElement.clientHeight > 100 ? dmCanvas.parentElement.clientHeight * 0.8 : 200;
            dmCanvas.width = placeholderWidth;
            dmCanvas.height = placeholderHeight;
            ctx.fillStyle = '#2a3138';
            ctx.fillRect(0, 0, dmCanvas.width, dmCanvas.height);
            ctx.fillStyle = '#555';
            ctx.font = '20px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Upload a main map to begin', dmCanvas.width / 2, dmCanvas.height / 2);
        }
        drawPlaceholder();

        // --- Campaign Save/Load ---
        const saveCampaignButton = document.getElementById('save-campaign-button');
        const loadCampaignInput = document.getElementById('load-campaign-input');
        // The label `load-campaign-label` is already handled by `for="load-campaign-input"`

        saveCampaignButton.addEventListener('click', () => {
            if (!campaignData.mainMapUrl) {
                alert("Please upload a main map before saving.");
                return;
            }

            // Sanity check: ensure all submap areas have originalImgW and originalImgH
            for (const subMap of campaignData.subMaps) {
                if (!subMap.area.originalImgW || !subMap.area.originalImgH) {
                    console.error("SubMap area is missing original image dimensions:", subMap.area);
                    alert("Error: Some submap data is incomplete. Cannot save reliably. Please re-select affected submap areas.");
                    return;
                }
            }

            const jsonData = JSON.stringify(campaignData, null, 2); // Pretty print JSON
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dndemicube-campaign.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log("Campaign saved.");
        });

        loadCampaignInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);

                        // Basic validation of loaded data structure
                        if (!loadedData.mainMapUrl || !Array.isArray(loadedData.subMaps)) {
                            throw new Error("Invalid campaign file structure.");
                        }
                        // More detailed validation for subMaps can be added here if necessary
                        loadedData.subMaps.forEach((sm, index) => {
                            if (!sm.area || !sm.mapUrl || !sm.area.originalImgW || !sm.area.originalImgH) {
                                throw new Error(`Invalid data for sub-map at index ${index}.`);
                            }
                        });


                        campaignData = loadedData;

                        // Load the main map image
                        if (campaignData.mainMapUrl) {
                            const img = new Image();
                            img.onload = () => {
                                currentMapImage = img;
                                // Ensure mainMapName and subMap names are present, provide defaults if not
                                campaignData.mainMapName = campaignData.mainMapName || "Main Map";
                                campaignData.subMaps.forEach((sm, i) => {
                                    sm.name = sm.name || `Sub-Map ${i + 1}`;
                                });

                                drawDmMap(); // This will draw main map and all submap areas
                                updateActiveMapsList(); // Update the list

                                // If player window is open, send the new main map
                                if (playerWindow && !playerWindow.closed) {
                                    playerWindow.postMessage({ type: 'showMainMap', mapDataUrl: campaignData.mainMapUrl }, '*');
                                    // Player view defaults to main map after a campaign load
                                }
                                console.log("Campaign loaded successfully.");
                            };
                            img.onerror = () => {
                                console.error("Error loading main map image from loaded campaign data.");
                                alert("Error loading main map from campaign file. The map image data might be corrupted or inaccessible.");
                                // Reset to a blank state or handle error more gracefully
                                currentMapImage = null;
                                campaignData = { mainMapName: "Main Map", mainMapUrl: null, subMaps: [] };
                                drawPlaceholder();
                                updateActiveMapsList(); // Clear the list
                            };
                            img.src = campaignData.mainMapUrl;
                        } else {
                            // No main map in loaded data, reset view
                            currentMapImage = null;
                            campaignData = { mainMapName: "Main Map", mainMapUrl: null, subMaps: [] }; // Ensure it's reset
                            drawPlaceholder();
                            updateActiveMapsList(); // Clear the list
                            alert("Loaded campaign data does not contain a main map URL.");
                        }
                    } catch (error) {
                        console.error("Error parsing or validating campaign file:", error);
                        alert(`Failed to load campaign: ${error.message}`);
                        // Reset to a known good state on error
                        campaignData = { mainMapName: "Main Map", mainMapUrl: null, subMaps: [] };
                        currentMapImage = null;
                        drawPlaceholder();
                        updateActiveMapsList();
                    } finally {
                        loadCampaignInput.value = null; // Reset file input
                    }
                };
                reader.onerror = () => {
                    console.error("Error reading campaign file.");
                    alert("Error reading campaign file.");
                    loadCampaignInput.value = null; // Reset file input
                };
                reader.readAsText(file);
            }
        });

    </script>
</body>
</html>
